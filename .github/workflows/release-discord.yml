name: Notify Discord on Release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: release-discord
      cancel-in-progress: false
    steps:
      - name: Post release to Discord
        continue-on-error: true
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TAG: ${{ github.event.release.tag_name }}
          NAME: ${{ github.event.release.name }}
          URL: ${{ github.event.release.html_url }}
          BODY: ${{ github.event.release.body }}
        run: |
          body_trunc="$(printf '%s' "$BODY" | head -c 1800)"
          jq -n --arg title "Nouvelle release $TAG" \
                --arg url "$URL" \
                --arg desc "$body_trunc" \
                '{
                  username: "Releases",
                  allowed_mentions: { parse: [] },
                  embeds: [{
                    title: $title,
                    url: $url,
                    description: $desc,
                    color: 5814783,
                    timestamp: (now | todate)
                  }]
                }' \
          | curl -sS -H 'Content-Type: application/json' -X POST -d @- "$WEBHOOK_URL"
